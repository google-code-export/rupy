#summary How to build completely async HTTP proxy chains for REST SOA.
#labels Featured,Phase-Design,Phase-Implementation

This [http://test.rupy.se/fusion?host=www.aftonbladet.se example] proxies data  from a rather large swedish homepage to your browser via a rupy instance on a raspberry pi with zero thread iowait and memory footprint. You can try to refresh the page and view the [http://monitor.rupy.se monitor] to see CPU usage (blue is iowait).

In the graph below:

  # Server & client sync.
  # Client async.
  # Fuse server & client async.

http://rupy.se/fusion.gif

If you wan't to use microservices this is the most performant way to build your service network. You can even use this as a load balancer.

{{{
public static class Fusion extends Service {
	CloseableHttpAsyncClient client;
	public void create(Daemon daemon) {
		client = HttpAsyncClients.createMinimal();
		client.start();
	}
	public void destroy() throws Exception {
		client.close();
	}
	public String path() { return "/fusion"; }
	public void filter(Event event) throws Event, Exception {
		if(event.push()) {
			Output out = event.output();
			HttpResponse response = (HttpResponse) event.query().get("response");
			out.println("iowait avoided: " + (event.big("stop") - event.big("start")) + " ms.<br>");
			Deploy.pipe(response.getEntity().getContent(), out);
			out.finish();
			out.flush();
		}
		else {
			event.query().parse();
			String host = event.string("host");
			HttpGet request = new HttpGet("http://" + host);
			EventFutureCallback callback = new EventFutureCallback<HttpResponse>(event);
			Future<HttpResponse> future = client.execute(request, callback);
			long time = System.currentTimeMillis();
			event.query().put("start", time);
		}
	}
	public static class EventFutureCallback<HttpResponse> implements FutureCallback<HttpResponse> {
		Event event;
		public EventFutureCallback(Event event) {
			this.event = event;
		}
		public void completed(HttpResponse response) {
			event.query().put("stop", System.currentTimeMillis());
			event.query().put("response", response);
			event.reply().wakeup();
		}
		public void failed(final Exception e) {
			System.out.println("Failed " + e);
		}
		public void cancelled() {
			System.out.println("Cancelled");
		}
	}
}
}}}