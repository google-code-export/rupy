#summary How to configure linux to serve large files with NIO.
#labels Phase-Deploy

Because NIO uses a few threads to serve many clients, it will/should/can _not_ block to wait for slow connections.

So we have 3 options:

  # Drop slow connections (default).
  # Wait for slow connections, we need more threads: -delay 60000 -threads 50 (not ideal)
  # Increase socket write buffer (memory usage). (preferred)

So if you see these kind of errors in log/error.txt your clients are getting dropped:

{{{
13-05-28 22:46:29.884 70.138.240.112 /[someLargeFile/Service]

...

Caused by: java.lang.Exception: IO timeout. ([delay])
        at se.rupy.http.Event.block(Event.java:381)
        at se.rupy.http.Output.internal(Output.java:263)
        at se.rupy.http.Output.wrote(Output.java:225)
        ... 7 more
}}}

Since kernel 2.4 TCP auto-tuning has been in the kernel. So all we have to do is increase the max limit (for example, as root):

{{{
> echo 'net.core.wmem_max=5242880' >> /etc/sysctl.conf
> echo 'net.ipv4.tcp_wmem=16384 65536 5242880' >> /etc/sysctl.conf
> sysctl -p
}}}

Here you can play with the numbers, for me 5 MB is enough since our largest file is 5 MB.

So a complementary solution is to compress your uncompressed static files with [https://code.google.com/p/rupy/wiki/GZIPService GZip].

Increasing the write buffer will increase your memory usage, for more details: [http://www.cyberciti.biz/faq/linux-tcp-tuning/ linux-tcp-tuning]