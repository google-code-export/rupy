#summary How to stream chunks in real-time.
#labels Featured,Phase-Implementation

You can now [http://rupy.googlecode.com/files/talk-1.0.zip stream] messages over HTTP with rupy.

As [http://www.ietf.org/id/draft-talk-comet-stream-protocol-00.txt RFC] specification I supply this reference implementation.

The message performance of the test included above:<br>

||CPU (s)||usage||in/s||out/s||total/s||
||3770S (4)||0%||~4.000||~9.000||~13.000||
||D510MO (2)||80-120%||~3.000||~6.000||~9.000||
||RPi (1)||99%||~300||~700||~1.000||

You can try it quickly by right-clicking these two links and opening <br>
them in new windows (so you can see the stream in real-time):

  | [http://one.rupy.se/pull?name=one one] | < "hello" | [http://one.rupy.se/push?name=two&message=hello two] |

  You will then send "hello" from <i>two</i> to <i>one</i>. <br>
  Reloading <i>two</i> will resend the message.<br>
  You can play around with more windows <br>
  and <i>name=[http://one.rupy.se/pull?name=three three]&message=[http://one.rupy.se/push?name=two&message=hi hi]</i> values.

  If it doesn't work, try later or on host _two.rupy.se_ or <br>
  _tre.rupy.se_, somebody else might be trying it at the <br>
  same time.

  IE doesen't render until a certain amount is <br>
  received, so hold down F5 in <i>two</i> for a while.

This code allows you to receive dynamic chunks with flash:

{{{
package {
	import flash.errors.*;
	import flash.events.*;
	import flash.net.*;
	import flash.display.MovieClip;
	import flash.utils.setTimeout;

	public class Comet extends flash.display.MovieClip {
		var pull;
		var socket;
		var offset = 0;

		public function Comet() {
			var req = new URLRequest("http://one.rupy.se/pull?name=one");
			
			pull = new URLStream();
			pull.addEventListener(ProgressEvent.PROGRESS, progressHandler);
			
			try {
				pull.load(req);
			} catch(error) {
				trace("Unable to pull. " + error);
			}
			
			socket = new Socket();
			socket.connect("one.rupy.se", 80);
			
			for(var i = 1; i < 10; i++) {
				setTimeout(delay, 1000 * i);
			}
		}

		function delay() {
			socket.writeUTFBytes("POST /push HTTP/1.1\r\n");
			socket.writeUTFBytes("Host: one.rupy.se\r\n");
			socket.writeUTFBytes("Head: less\r\n"); // tells rupy to not send any headers
			socket.writeUTFBytes("\r\n");
			socket.writeUTFBytes("name=two&message=hello");
			socket.flush();
		}

		function progressHandler(event) {
			var progress = ProgressEvent(event);
			var message = pull.readUTFBytes(progress.bytesLoaded - offset);
			offset = progress.bytesLoaded;
			trace("in " + message);
		}
	}
}
}}}

Tutorial:

  * Create 2 new files:
    # _ActionScript_ - Paste the code above into it and save it as Comet.as.
    # _Flash (AS 3.0)_ - Edit the Class to 'Comet' in the PROPERTIES PUBLISH pane on the right, save in the same folder.
  * Then run Control -> Test Movie (Ctrl+Enter).