#summary How to deploy a MySQL connection pool on host.rupy.se
#labels Phase-Implementation

<font color="red">We are working on our own cluster database:</font> [https://code.google.com/p/rupy/wiki/Persistence root]

For true redundancy you need to use some custom cluster datastore since we now have hosting across multiple colocations!

Ordinary databases are not secure, scalable or redundant in a distributed cluster environment:

  * Database connections between colocations are not encrypted.
  * Databases don't have NIO; you can't scale them.
  * If the colocation where you host your database is down, your site will be down.
  * You need to backup your data.

We used Dropbox as a "key/value" store, simply writing and reading files with compressed and encrypted JSON content. So the user object is just a file; for example _*/user/marc*_ with _*{"pass": "sha", ...}*_ inside. Follow the tutorial to set it up for your application: [https://www.dropbox.com/developers/core/start/java]

You should use a password in a file that you upload once (then retrieve and protect with the following code) to encrypt the data:

{{{
static String secret;

public static String secret() throws Exception {
	if(secret == null) {
		RandomAccessFile file = new RandomAccessFile(new File("app/your.app.domain/secret"), "r");
		secret = file.readLine();
		file.close();
	}

	return secret;
}
}}}
{{{
public static class Protect extends Service {
	public String path() {
		return "/secret";
	}

	public void filter(Event event) throws Event, Exception {
		event.output().println("Nice try!");
	}
}
}}}

You could use Dropbox for static files too (images, css, etc) if you have a Public folder (accounts created after October 4, 2012 need to activate this [https://www.dropbox.com/enable_public_folder here]), othervise you have to store the unique URL of each file. Make sure you give your Dropbox app access to everything.

In the meantime; you register on the node you want your mysql database on: [http://one.rupy.se one] or [http://two.rupy.se two] hosted by FSData in Sweden and [http://tre.rupy.se tre] hosted by PCExtreme in the Netherlands. For now if you need security, you have to change the DNS to the node with the MySQL (100% secure unless hardware is tampered with which would be criminal and impossible for us to not notice) or the two swedish nodes (only FSData can snoop your data). But then, of course, you lose the up-time capable distribution!

Using [http://memory.googlecode.com memory] (you need to add memory.jar and util.jar to your classpath) ORM:

{{{
public class DataBase extends Service {
	public static Base BASE;
	public static Pool POOL;
	public static SQL SQL;

	public String path() { return "/somepath"; }

	public void create(Daemon daemon) {
                try {
                        SQL = new SQL(daemon);
                        POOL = new Pool(SQL, SQL);
                        BASE = new Base();
                        BASE.init(POOL);
                }
                catch(Exception e) {
                        e.printStackTrace();
                }
	}

	public void destroy() {
		POOL.close();
	}

	public void filter(Event event) throws Exception, Event {}

	public static class SQL implements Log, Settings {
		public String host, pass, ip;
		
		public SQL(Daemon daemon) throws Exception {
			JSONObject account = new JSONObject((String) daemon.send("{\"type\": \"account\"}"));
			host = account.getString("host");
			pass = account.getString("pass");
			ip = account.getString("ip");
		}

		public String driver() {
			return "com.mysql.jdbc.Driver";
		}

		public String url() {
			return "jdbc:mysql://" + ip + "/" + host.replaceAll("\\.", "_");
		}

		// MySQL username can only be 16 characters long
		public String user() {
			return pass;
		}

		public String pass() {
			return pass;
		}

		public void message(Object o) {}
	}
}
}}}