#summary How to deploy a MySQL connection pool on host.rupy.se
#labels Phase-Implementation

<font color="red">_*We recommend you use Dropbox (or any other distributed file storage) as database and only use MySQL for unsecure non-crucial indexes.*_</font>
<font color="red">_You need to contact Dropbox about request volumes and you might need a paid subscription._</font>

For true redundancy you need to use some custom cluster datastore since we now have hosting across multiple colocations!

<font color="orange">We are working on our own file replication, will post code as soon as it's done here!</font>

MySQL is not secure, scalable or uptime capable; database connections between the two colocations are not encrypted, and since databases don't have NIO; you can't scale them. Finally, if the colocation were you host your database is down, your site will be down.

We use Dropbox as a "key/value" store, simply writing and reading files with compressed and encrypted JSON content. So the user object is just a file; for example _*/user/marc*_ with _*{"pass": "sha", ...}*_ inside. Follow the tutorial to set it up for your application: [https://www.dropbox.com/developers/core/start/java]

You should use your host.rupy.se password (retrieved in the code below) to encrypt the data, we make sure that password is protected all the way to the JVM.

You could use Dropbox for static files too (images, css, etc) if you have a Public folder (accounts created after October 4, 2012 need to activate this [https://www.dropbox.com/enable_public_folder here]), othervise you have to store the unique URL of each image. Make sure you give your Dropbox app access to everything.

In the meantime; you register on the node you want your mysql database on: [http://one.rupy.se one] or [http://two.rupy.se two] hosted by FSData in Sweden and [http://tre.rupy.se tre] hosted by PCExtreme in the Netherlands. For now if you need security, you have to change the DNS to the node with the MySQL (100% secure unless hardware is tampered with which would be criminal and impossible for us to not notice) or the two swedish nodes (only FSData can snoop your data).

Using [http://memory.googlecode.com memory] (you need to add memory.jar and util.jar to your classpath) ORM:

{{{
public class DataBase extends Service {
	public static Base BASE;
	public static Pool POOL;
	public static SQL SQL;

	public String path() { return "/somepath"; }

	public void create(Daemon daemon) {
                try {
                        SQL = new SQL(daemon);
                        POOL = new Pool(SQL, SQL);
                        BASE = new Base();
                        BASE.init(POOL);
                }
                catch(Exception e) {
                        e.printStackTrace();
                }
	}

	public void destroy() {
		POOL.close();
	}

	public void filter(Event event) throws Exception, Event {}

	public static class SQL implements Log, Settings {
		public String host, pass, ip;
		
		public SQL(Daemon daemon) throws Exception {
			JSONObject account = new JSONObject((String) daemon.send("{\"type\": \"account\"}"));
			host = account.getString("host");
			pass = account.getString("pass");
			ip = account.getString("ip");
		}

		public String driver() {
			return "com.mysql.jdbc.Driver";
		}

		public String url() {
			return "jdbc:mysql://" + ip + "/" + host.replaceAll("\\.", "_");
		}

		// MySQL username can only be 16 characters long
		public String user() {
			return pass;
		}

		public String pass() {
			return pass;
		}

		public void message(Object o) {}
	}
}
}}}